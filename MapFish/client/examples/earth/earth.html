<!DOCTYPE html>
<html>
<head>
  <title>MapFish / Google Earth</title>
    <link rel="stylesheet" type="text/css" href="../../mfbase/ext/resources/css/ext-all.css" />

    <script type="text/javascript" src="../../mfbase/openlayers/lib/Firebug/firebug.js"></script>
    <script type="text/javascript" src="../../mfbase/openlayers/lib/OpenLayers.js"></script>

    <script type="text/javascript" src="../../mfbase/ext/adapter/ext/ext-base.js"></script>
    <script type="text/javascript" src="../../mfbase/ext/ext-all-debug.js"></script>

    <script type="text/javascript">
      // Because of a bug in Firefox 2 we need to specify the MapFish base path.
      // See https://bugzilla.mozilla.org/show_bug.cgi?id=351282
      var gMfLocation = "../../mfbase/mapfish/";
    </script>
    <script type="text/javascript" src="../../mfbase/mapfish/MapFish.js"></script>
    <script type="text/javascript" src="../examples.js"></script>
    <!-- this gmaps key generated for http://mapfish.org/ -->    
    <script type="text/javascript" src="http://www.google.com/jsapi?key=ABQIAAAADFaQ38WSNC0O1B0gddpOThT4JpmMUiFK_Nz2ZaTK9LISRzvc_hTj_y3aDzoLqzYV9iHWvvwwew0bTQ"></script>
    <script type="text/javascript" src="Earth.js"></script>
    
	<style type="text/css">
	html, body {
        margin: 0;
        padding: 0;
        border: 0 none;
        overflow: hidden;
        height: 100%;
    }
    #map3dContainer {
        width: 100%;
        height: 100%;        
    }
    </style>
	<script type="text/javascript">
  
    // reference local blank image
    Ext.BLANK_IMAGE_URL = '../../mfbase/ext/resources/images/default/s.gif';
  
    Ext.onReady(function() {
        
        // Creates OpenLayers 2D map
        var options = {
            projection: "EPSG:900913",
            units: "m",
            maxResolution: 156543.0339,
            maxExtent: new OpenLayers.Bounds(-20037508, -20037508,
                                             20037508, 20037508.34)
        };
        map = new OpenLayers.Map('mapContainer', options);

        // Creates OSM layer
        var mapnik = new OpenLayers.Layer.TMS(
            "OpenStreetMap",
            "http://tile.openstreetmap.org/",
            {
                type: 'png', getURL: osm_getTileURL,
                displayOutsideMaxExtent: true
            }
        );
        map.addLayers([mapnik]);
                                   
        var mapcomponent = new mapfish.widgets.MapComponent({map: map});
       
        var viewport = new Ext.Viewport({
            layout:'border',
                items: [
                    {
                        region: 'center',
                        contentEl: 'mapContainer',
                        minWidth: 200,
                        title: 'MapFish 2D'
                    },{
                        region: 'east',
                        width: '40%',
                        contentEl: 'map3dContainer',
                        split: true,
                        collapsible: true,
                        collapseMode: 'mini',
                        minWidth: 400,
                        title: 'MapFish 3D Featuring Google Earth'
                    }]
        });
        
        var center = new OpenLayers.LonLat(-13625995.09, 4550849.74);        
        map.setCenter(center, 14);               
        
        // Creates GE plugin
        earth = new mapfish.Earth(map, 'map3dContainer', {lonLat: center,
                                                          altitude: 50,
                                                          heading: -60,
                                                          tilt: 70,
                                                          range: 700});
    });
        
    function osm_getTileURL(bounds) {
        var res = this.map.getResolution();
        var x = Math.round((bounds.left - this.maxExtent.left) / (res * this.tileSize.w));
        var y = Math.round((this.maxExtent.top - bounds.top) / (res * this.tileSize.h));
        var z = this.map.getZoom();
        var limit = Math.pow(2, z);
        
        if (y < 0 || y >= limit) {
            return OpenLayers.Util.getImagesLocation() + "404.png";
        } else {
            x = ((x % limit) + limit) % limit;            
            return this.url + z + "/" + x + "/" + y + "." + this.type;
        }
    }
	</script>
</head>
<body>
  <div id="mapContainer"></div>
  <div id="map3dContainer">
  </div>
 </body>
</html>
